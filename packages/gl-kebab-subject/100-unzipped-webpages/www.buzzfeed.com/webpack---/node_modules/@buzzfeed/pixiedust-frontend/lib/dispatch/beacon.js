import defaults from 'lodash/defaults';
import extend from 'lodash/extend';
import settings from '../settings';

const MAX_BATCH_SIZE = 10;
const BATCH_DELAY = 200;

export function BeaconDispatch() {
    let eventQueue = [];
    let sessionVars = {};
    let batchTimeout;

    return {
        setSessionVars(vars) {
            sessionVars = extend(sessionVars, vars);
        },

        sendData() {
            if (!eventQueue.length) {
                return;
            }

            const data = JSON.stringify(eventQueue);
            const sent = navigator.sendBeacon(`${settings.get('trackingURL')}/events`, data);
            if (!sent && window.raven) {
                window.raven.captureException('Pixiedust: sendBeacon could not process a queue.');
            }
            clearTimeout(batchTimeout);
            batchTimeout = null;
            eventQueue = [];
        },

        push(data) {
            eventQueue.push(defaults({}, data, sessionVars));
            if (eventQueue.length === MAX_BATCH_SIZE) {
                this.sendData();
            }
            if (!batchTimeout) {
                batchTimeout = setTimeout(this.sendData, BATCH_DELAY);
            }
        }
    };
}