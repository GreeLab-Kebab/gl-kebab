import {
    Application
} from 't3js';
import abeagle from '@buzzfeed/buzzblocks/js/services/abeagle';
import template from '../../components/link-advertise/index.html';
import '../../components/link-advertise';


function linkAdvertise(proto) {
    return {
        /**
         * Insert link-advertise module after ad element.
         * @return {void}
         */
        setup() {
            proto.setup.call(this, ...arguments);
            abeagle.getExperimentVariant('advertise_international', {
                    rejectErrors: false
                })
                .then((variant) => {
                    if (variant !== 'on') {
                        return;
                    }
                    this.on(`ad-content-ready-${this.config.wid}`, ({
                        data: {
                            type,
                            buzz
                        }
                    }) => {
                        if (type.match(/programmatic|impression_pixel/) || (buzz && /other/.test(buzz.user_type))) {
                            return;
                        }
                        this.element.insertAdjacentHTML('beforeend', template.render({
                            'slot': this.config
                        }));
                        Application.start(this.element.lastElementChild);
                    });
                });
        },
    };
}


export {
    linkAdvertise
};