import {
    has,
    get
} from 'lodash';

export function pixiedustMap(mapper, setCommonData) {

    const servicesToCategories = {
        'feedpager': 'feed',
        'bpager': 'buzz'
    };

    const scrollRouter = mapper.getOrCreateRouter('track/scroll/impression');
    const clickRouter = mapper.getOrCreateRouter('track/click');

    const impressionMap = scrollRouter.createConfigForRoute(function(src) {
        return src.l === 'buzzblocks/Package';
    });

    const clickMap = clickRouter.createConfigForRoute(function(src) {
        return src.l === 'buzzblocks/Package';
    });

    setCommonData(impressionMap, [
        'mode',
        'page_url',
        'os',
        'position',
        'content_id',
        'unit_client_id',
        'post_category',
        'variation_id',
        'data_source',
        'treatment',
    ]);
    impressionMap.addMapTo('type', 'unit_impression');
    impressionMap.addMapTo('unit', 'package');
    impressionMap.addMapTo('sub_unit', '').mapFrom('d');
    impressionMap.addMapTo('page_type', '').mapFrom(function(src) {
        return has(servicesToCategories, get(src, 'data.page.platform')) ?
            servicesToCategories[get(src, 'data.page.platform')] : get(src, 'data.page.platform');
    });


    setCommonData(clickMap, [
        'mode',
        'page_url',
        'os',
        'position',
        'post_category',
        'content_id',
        'unit_client_id',
        'variation_id',
        'data_source',
        'treatment',
    ]);

    clickMap.addMapTo('type', 'unit_click');
    clickMap.addMapTo('unit', 'package');
    clickMap.addMapTo('sub_unit', '').mapFrom('d');
    clickMap.addMapTo('sub_position', '').mapFrom(function(src) {
        if (src.data && src.data.sub_p) {
            return src.data.sub_p;
        }
        return '';
    });

    clickMap.addMapTo('page_type', '').mapFrom(function(src) {
        return has(servicesToCategories, get(src, 'data.page.platform')) ?
            servicesToCategories[get(src, 'data.page.platform')] : get(src, 'data.page.platform');
    });
}