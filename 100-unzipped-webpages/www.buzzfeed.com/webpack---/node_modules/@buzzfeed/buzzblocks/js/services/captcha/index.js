/* global grecaptcha */

import util from '../util/standalone';

const CAPTCHA_SITE_KEY = '6LfLj3cUAAAAAGP64Tcvsoy3_QftH6_TNkp4HfqV';
const CAPTCHA_URL = `https://www.google.com/recaptcha/api.js?render=${CAPTCHA_SITE_KEY}`;
let initialized;

/**
 * Service used with captcha component to detect NONHUMANS
 */
const captcha = {};

/**
 * Lazy-load google recaptcha script.
 * @return {Promise}
 */
captcha.init = function() {
    if (!initialized) {
        initialized = util.createScript(CAPTCHA_URL)
            .catch(err => console.error(`Failed to build captcha: ${err}`));
    }
    return initialized;
};

/**
 * Get captcha response from #g-recaptcha-response.
 * @param {string} action - e.g. newsletter, login, etc
 * @return {Promise}
 */
captcha.validate = function(action = 'newsletter') {
    return new Promise((resolve, reject) => {
        if (typeof grecaptcha === 'undefined') {
            reject(`Failed to validate captcha: grecaptcha is not defined`);
        } else {
            grecaptcha.ready(() => {
                grecaptcha.execute(CAPTCHA_SITE_KEY, {
                        action: action
                    })
                    .then(resolve);
            });
        }
    });
};

export default captcha;