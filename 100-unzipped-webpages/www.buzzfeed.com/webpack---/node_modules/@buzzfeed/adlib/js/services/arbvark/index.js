/*
 * Arbvark! A hackweek-2019 project that could live forever.
 * If there is a query param of 'arbvark' set the k/v 'arbvark': '1'
 * The query param 'origin=' is also passed to the affiliate link subtag
 * Contact Bryan Harris, James LeDoux, or Patrick Carey
 */

import abeagle from '@buzzfeed/buzzblocks/js/services/abeagle';
import {
    Disabled
} from '../../../core/error';

const FEATURE_FLAG = 'ads_arbvark';
let _initializing;

function loadArbvark() {
    return new Promise((resolve, reject) => {
        var googletag = window.googletag || {};
        const params = document.location.search;
        if (params && params.match('arbvark')[0] === 'arbvark') {
            googletag.cmd.push(() => {
                googletag.pubads().setTargeting('arbvark', '1');
            });
            resolve();
        } else {
            reject();
        }

    });
}

export default {
    init() {
        if (_initializing) {
            return _initializing;
        }

        return _initializing = abeagle.isOn(FEATURE_FLAG)
            .then((isOn) => isOn ? Promise.resolve(true) : Promise.reject(new Disabled()))
            .then(() => loadArbvark())
            .catch((error) => {
                if (!(error instanceof Disabled)) {
                    console.error(error);
                }
                return Promise.resolve(true);
            });
    }
};