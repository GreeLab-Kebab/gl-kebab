import abeagle from '@buzzfeed/buzzblocks/js/services/abeagle';
import {
    Disabled
} from '../../../core/error';

const FEATURE_FLAG = 'ads_adrizer';
const AD_RIZER_URL = '//run.adrizer.com/track.min.js';
let _initializing;

function loadAdRizerScript() {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.onload = () => resolve(script);
        script.onerror = () => {
            reject('AdRizer: Script failed to load');
        };
        script.src = AD_RIZER_URL;
        script.async = true;
        script.dataset.domain = 'buzzfeed.com';
        script.id = 'ADRIZER_JS';
        document.head.appendChild(script);
    });
}

export default {
    init() {
        if (_initializing) {
            return _initializing;
        }

        return _initializing = abeagle.isOn(FEATURE_FLAG)
            .then((isOn) => isOn ? Promise.resolve(true) : Promise.reject(new Disabled()))
            .then(() => loadAdRizerScript())
            .catch((error) => {
                // if script fails, always succeed
                // but log if we get an error due to being disabled!
                if (!(error instanceof Disabled)) {
                    console.error(error);
                }
                return Promise.resolve(true);
            });
    }
};