"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
var cookies_1 = require("./cookies");
var consent_logs_1 = require("./consent-logs");
var config_1 = require("./config");
exports.setupMessageHandlers = function(onReadyCmp, onCloseCmp, onErrorCmp) {
    var receiveMessage = function(event) {
        var withErrorHandling = function(callback) {
            try {
                callback();
            } catch (e) {
                onErrorCmp(e);
            }
        };
        var origin = event.origin,
            data = event.data;
        if (origin !== config_1.CMP_DOMAIN) {
            return;
        }
        var msgType = data.msgType,
            msgData = data.msgData;
        switch (msgType) {
            case config_1.CMP_READY_MSG:
                withErrorHandling(onReadyCmp);
                break;
            case config_1.CMP_CLOSE_MSG:
                withErrorHandling(onCloseCmp);
                break;
            case config_1.CMP_SAVED_MSG:
                consent_logs_1.logConsent(msgData)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error("Error posting to consent logs: " + response.status + " | " + response.statusText);
                        }
                    })
                    .catch(function(error) {
                        onErrorCmp(error);
                    });
                break;
            default:
                break;
        }
    };
    window.addEventListener('message', receiveMessage, false);
};
exports.canShow = function() {
    return !cookies_1.readIabCookie();
}; // TODO: Restore readGuCookie check once we start saving GU cookie