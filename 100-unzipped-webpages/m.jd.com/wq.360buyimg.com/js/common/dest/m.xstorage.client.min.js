(function(e) {
    ! function(e) {
        function t() {}

        function n(e, t) {
            return function() {
                e.apply(t, arguments)
            }
        }

        function r(e) {
            if ("object" != typeof this) throw new TypeError("Promises must be constructed via new");
            if ("function" != typeof e) throw new TypeError("not a function");
            this._state = 0, this._handled = !1, this._value = void 0, this._deferreds = [], a(e, this)
        }

        function o(e, t) {
            for (; 3 === e._state;) e = e._value;
            return 0 === e._state ? void e._deferreds.push(t) : (e._handled = !0, void r._immediateFn(function() {
                var n = 1 === e._state ? t.onFulfilled : t.onRejected;
                if (null === n) return void(1 === e._state ? i : s)(t.promise, e._value);
                var r;
                try {
                    r = n(e._value)
                } catch (e) {
                    return void s(t.promise, e)
                }
                i(t.promise, r)
            }))
        }

        function i(e, t) {
            try {
                if (t === e) throw new TypeError("A promise cannot be resolved with itself.");
                if (t && ("object" == typeof t || "function" == typeof t)) {
                    var o = t.then;
                    if (t instanceof r) return e._state = 3, e._value = t, void c(e);
                    if ("function" == typeof o) return void a(n(o, t), e)
                }
                e._state = 1, e._value = t, c(e)
            } catch (t) {
                s(e, t)
            }
        }

        function s(e, t) {
            e._state = 2, e._value = t, c(e)
        }

        function c(e) {
            2 === e._state && 0 === e._deferreds.length && r._immediateFn(function() {
                e._handled || r._unhandledRejectionFn(e._value)
            });
            for (var t = 0, n = e._deferreds.length; t < n; t++) o(e, e._deferreds[t]);
            e._deferreds = null
        }

        function u(e, t, n) {
            this.onFulfilled = "function" == typeof e ? e : null, this.onRejected = "function" == typeof t ? t : null, this.promise = n
        }

        function a(e, t) {
            var n = !1;
            try {
                e(function(e) {
                    n || (n = !0, i(t, e))
                }, function(e) {
                    n || (n = !0, s(t, e))
                })
            } catch (e) {
                if (n) return;
                n = !0, s(t, e)
            }
        }
        var f = setTimeout;
        r.prototype["catch"] = function(e) {
            return this.then(null, e)
        }, r.prototype.then = function(e, n) {
            var r = new this.constructor(t);
            return o(this, new u(e, n, r)), r
        }, r.all = function(e) {
            var t = Array.prototype.slice.call(e);
            return new r(function(e, n) {
                function r(i, s) {
                    try {
                        if (s && ("object" == typeof s || "function" == typeof s)) {
                            var c = s.then;
                            if ("function" == typeof c) return void c.call(s, function(e) {
                                r(i, e)
                            }, n)
                        }
                        t[i] = s, 0 === --o && e(t)
                    } catch (e) {
                        n(e)
                    }
                }
                if (0 === t.length) return e([]);
                for (var o = t.length, i = 0; i < t.length; i++) r(i, t[i])
            })
        }, r.resolve = function(e) {
            return e && "object" == typeof e && e.constructor === r ? e : new r(function(t) {
                t(e)
            })
        }, r.reject = function(e) {
            return new r(function(t, n) {
                n(e)
            })
        }, r.race = function(e) {
            return new r(function(t, n) {
                for (var r = 0, o = e.length; r < o; r++) e[r].then(t, n)
            })
        }, r._immediateFn = "function" == typeof setImmediate && function(e) {
            setImmediate(e)
        } || function(e) {
            f(e, 0)
        }, r._unhandledRejectionFn = function(e) {
            "undefined" != typeof console && console && console.warn("Possible Unhandled Promise Rejection:", e)
        }, r._setImmediateFn = function(e) {
            r._immediateFn = e
        }, r._setUnhandledRejectionFn = function(e) {
            r._unhandledRejectionFn = e
        }, "undefined" != typeof module && module.exports ? module.exports = r : e._Promise || (e._Promise = r)
    }(e);

    function t(n) {
        var r = "//wqs.jd.com/portal/wx/m_storage_hub.html";
        n = n || {};
        this._id = t._generateUUID();
        this._promise = n.promise || e._Promise || Promise;
        this._frameId = n.frameId || "CrossStorageClient-" + this._id;
        this._origin = t._getOrigin(r);
        this._requests = {};
        this._connected = false;
        this._closed = false;
        this._count = 0;
        this._timeout = n.timeout || 5e3;
        this._listener = null;
        this._installListener();
        var o;
        if (n.frameId) {
            o = document.getElementById(n.frameId)
        }
        if (o) {
            this._poll()
        }
        o = o || this._createFrame(r);
        this._hub = o.contentWindow
    }
    t.frameStyle = {
        display: "none",
        position: "absolute",
        top: "-999px",
        left: "-999px"
    };
    t._getOrigin = function(e) {
        var t, n, r;
        t = document.createElement("a");
        t.href = e;
        if (!t.host) {
            t = window.location
        }
        if (!t.protocol || t.protocol === ":") {
            n = window.location.protocol
        } else {
            n = t.protocol
        }
        r = n + "//" + t.host;
        r = r.replace(/:80$|:443$/, "");
        return r
    };
    t._generateUUID = function() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(e) {
            var t = Math.random() * 16 | 0,
                n = e == "x" ? t : t & 3 | 8;
            return n.toString(16)
        })
    };
    t.prototype.onConnect = function() {
        var e = this;
        if (this._connected) {
            return this._promise.resolve()
        } else if (this._closed) {
            return this._promise.reject(new Error("CrossStorageClient has closed"))
        }
        if (!this._requests.connect) {
            this._requests.connect = []
        }
        return new this._promise(function(t, n) {
            var r = setTimeout(function() {
                n(new Error("CrossStorageClient could not connect"))
            }, e._timeout);
            e._requests.connect.push(function(e) {
                clearTimeout(r);
                if (e) return n(e);
                t()
            })
        })
    };
    t.prototype.set = function(e, t) {
        return this._request("set", {
            key: e,
            value: t
        })
    };
    t.prototype.get = function(e) {
        var t = Array.prototype.slice.call(arguments);
        return this._request("get", {
            keys: t
        })
    };
    t.prototype.del = function() {
        var e = Array.prototype.slice.call(arguments);
        return this._request("del", {
            keys: e
        })
    };
    t.prototype.clear = function() {
        return this._request("clear")
    };
    t.prototype.getKeys = function() {
        return this._request("getKeys")
    };
    t.prototype.close = function() {
        var e = document.getElementById(this._frameId);
        if (e) {
            e.parentNode.removeChild(e)
        }
        if (window.removeEventListener) {
            window.removeEventListener("message", this._listener, false)
        } else {
            window.detachEvent("onmessage", this._listener)
        }
        this._connected = false;
        this._closed = true
    };
    t.prototype._installListener = function() {
        var e = this;
        this._listener = function(t) {
            var n, r, o, i;
            if (e._closed || !t.data || typeof t.data !== "string") {
                return
            }
            r = t.origin === "null" ? "file://" : t.origin;
            if (r !== e._origin) return;
            if (t.data === "cross-storage:unavailable") {
                if (!e._closed) e.close();
                if (!e._requests.connect) return;
                o = new Error("Closing client. Could not access localStorage in hub.");
                for (n = 0; n < e._requests.connect.length; n++) {
                    e._requests.connect[n](o)
                }
                return
            }
            if (t.data.indexOf("cross-storage:") !== -1 && !e._connected) {
                e._connected = true;
                if (!e._requests.connect) return;
                for (n = 0; n < e._requests.connect.length; n++) {
                    e._requests.connect[n](o)
                }
                delete e._requests.connect
            }
            if (t.data === "cross-storage:ready") return;
            try {
                i = JSON.parse(t.data)
            } catch (e) {
                return
            }
            if (!i.id) return;
            if (e._requests[i.id]) {
                e._requests[i.id](i.error, i.result)
            }
        };
        if (window.addEventListener) {
            window.addEventListener("message", this._listener, false)
        } else {
            window.attachEvent("onmessage", this._listener)
        }
    };
    t.prototype._poll = function() {
        var e, t, n;
        e = this;
        n = e._origin === "file://" ? "*" : e._origin;
        t = setInterval(function() {
            if (e._connected) return clearInterval(t);
            if (!e._hub) return;
            e._hub.postMessage("cross-storage:poll", n)
        }, 1e3)
    };
    t.prototype._createFrame = function(e) {
        var n, r;
        n = window.document.createElement("iframe");
        n.id = this._frameId;
        for (r in t.frameStyle) {
            if (t.frameStyle.hasOwnProperty(r)) {
                n.style[r] = t.frameStyle[r]
            }
        }
        window.document.body.appendChild(n);
        n.src = e;
        return n
    };
    t.prototype._request = function(e, t) {
        var n, r;
        if (this._closed) {
            return this._promise.reject(new Error("CrossStorageClient has closed"))
        }
        r = this;
        r._count++;
        n = {
            id: this._id + ":" + r._count,
            method: "cross-storage:" + e,
            params: t
        };
        return new this._promise(function(e, t) {
            var o, i, s;
            o = setTimeout(function() {
                if (!r._requests[n.id]) return;
                delete r._requests[n.id];
                t(new Error("Timeout: could not perform " + n.method))
            }, r._timeout);
            r._requests[n.id] = function(i, s) {
                clearTimeout(o);
                delete r._requests[n.id];
                if (i) return t(new Error(i));
                e(s)
            };
            if (Array.prototype.toJSON) {
                i = Array.prototype.toJSON;
                Array.prototype.toJSON = null
            }
            s = r._origin === "file://" ? "*" : r._origin;
            r._hub.postMessage(JSON.stringify(n), s);
            if (i) {
                Array.prototype.toJSON = i
            }
        })
    };
    e.CrossStorageClient = t
})(window);